# DU Customizations Extraction Scripts

Automated scripts to extract DU-specific customizations from `sparkle.css` (Foundation 6.7.5 based) by removing library styles and replacing hardcoded values with SCSS variables.

## Overview

When `sparkle.css` changes (e.g., after Foundation updates or major style additions), this process regenerates `scss/_du-customizations-only.scss` to contain only DU-specific customizations with proper variable usage.

## Prerequisites

- Node.js 24+ (as specified in `.nvmrc`)
- npm dependencies installed (`npm install`)
- `dest/sparkle.css` must exist (generated by build process)
- `dest/foundation.css` must exist (Foundation 6.7.5 compiled output)

## Usage

Run the complete extraction process:

```bash
npm run extract-customizations
```

This executes the following steps:

1. **Build Reference Libraries** - Concatenates Foundation, Drupal tabs, and Slick CSS into a single reference file
2. **Extract Customizations** - Parses `sparkle.css`, removes exact library matches, replaces colors/fonts with SCSS variables
3. **Build CSS** - Compiles SCSS to CSS using Gulp
4. **Create Backup** - Saves `dest/style.css` as `dest/style.css.backup` for comparison
5. **Validate** - Compares backup with new output, flags any visual differences

## Scripts

### `scripts/foundation-675-reference.css`

**Static reference file** containing Foundation 6.7.5 CSS (extracted from sparkle.css). This file is committed to the repository and used for all extraction comparisons.

**Why Foundation 6.7.5?** The legacy sparkle.css was built with Foundation 6.7.5, so we must compare against the same version to accurately identify DU customizations.

### `scripts/extract-foundation-reference.js`

One-time script used to create `foundation-675-reference.css`. Already run - you don't need to run this again unless sparkle.css changes significantly.

### `scripts/build-reference-libs.js`

Concatenates library CSS files into `.reference-libs.css`:
- `foundation-675-reference.css` (Foundation 6.7.5 static reference)
- `web/themes/contrib/seven/css/components/tabs.css` (Drupal tabs)
- `web/libraries/slick-carousel/slick/slick.css` (Slick carousel)

### `scripts/extract-customizations.js`

Main extraction logic:
- Parses `dest/sparkle.css` using PostCSS
- Loads color/font variable definitions from `scss/_variables.scss`
- Removes CSS rules that exactly match reference libraries (selector + all declarations must match)
- Replaces hardcoded hex colors and font names with SCSS variables
- Ignores one-off colors not defined as variables
- Outputs to `scss/_du-customizations-only.scss`

### `scripts/validate-css-diff.js`

Validates the extraction didn't cause visual changes:
- Normalizes hex colors to lowercase 6-digit format (#FFFFFF → #ffffff)
- Compares `dest/style.css.backup` with `dest/style.css`
- Flags critical differences: any property change that affects visual rendering
- Accepts only hex format normalization as safe
- Generates detailed report in `scripts/extraction-diff-report.txt`
- **Exits with error if critical differences detected**

## Critical Visual Properties

The validator flags changes to these properties as critical errors:
- Colors: `color`, `background-color`, `border-color`, etc.
- Layout: `width`, `height`, `margin`, `padding`, `display`, `position`
- Typography: `font-family`, `font-size`, `font-weight`, `line-height`
- Visual effects: `opacity`, `box-shadow`, `text-shadow`, `transform`
- And more (see `VISUAL_PROPERTIES` in `validate-css-diff.js`)

## Expected Output

On success:
```
✓ VALIDATION PASSED - Files are identical
```

On failure:
```
✗ VALIDATION FAILED - Critical differences detected
  Total differences: X
  Critical differences: Y

See scripts/extraction-diff-report.txt for details.
```

## When to Run

- After updating Foundation or other CSS libraries
- When `sparkle.css` has accumulated new DU-specific styles
- After major theme refactoring
- Before deploying to ensure no unintended visual changes

## Troubleshooting

### "Missing required files"
Ensure you've run `npm run build` first to generate `dest/foundation.css` and `dest/sparkle.css`.

### Validation fails with critical differences
Review `scripts/extraction-diff-report.txt` to see what changed. Common causes:
- Variable replacement created different compiled output
- Library detection removed DU customizations (check exact match logic)
- New styles in sparkle.css conflict with existing variables

### Script errors
Check Node.js version matches `.nvmrc` (v24). Run `nvm use` if using nvm.

## Git Integration

The following files are ignored (`.gitignore`):
- `scripts/.reference-libs.css` - Temporary concatenated library CSS
- `scripts/extraction-diff-report.txt` - Validation report (regenerated each run)

The `scss/_du-customizations-only.scss` output file **should be committed** after successful extraction.

## Files Modified

- `package.json` - Added `postcss` and `postcss-scss` dependencies, added `extract-customizations` script
- `scss/_du-customizations-only.scss` - Regenerated by extraction process (commit after validation passes)
- `dest/style.css.backup` - Created during validation (can be deleted after validation)
